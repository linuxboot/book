<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>LinuxBoot using coreboot, u-root and systemboot - LinuxBoot</title>


        <!-- Custom HTML head -->
        <script>
            const mdbookPath = "coreboot.u-root.systemboot/index.md";
            const mdbookPathToRoot = "../";
        </script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/css/language-picker.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">LinuxBoot</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/linuxboot/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="linuxboot-using-coreboot-u-root-and-systemboot"><a class="header" href="#linuxboot-using-coreboot-u-root-and-systemboot">LinuxBoot using coreboot, u-root and systemboot</a></h1>
<p>Points of contact:
<a href="https://github.com/insomniacslk">Andrea Barberio</a>,
<a href="https://github.com/dhendrix">David Hendricks</a></p>
<p>This chapter describes how to build a LinuxBoot firmware based on coreboot,
u-root and systemboot.  The examples will focus on <code>x86_64</code>, and the coreboot
builds will cover virtual and physical OCP hardware.</p>
<h2 id="quick-start-with-coreboot"><a class="header" href="#quick-start-with-coreboot">Quick Start with coreboot</a></h2>
<p>Run these commands in a directory you create or in <code>/tmp</code>; do so because it
creates some files and directories:</p>
<pre><code>$ go get github.com/linuxboot/corebootnerf
$ go run github.com/linuxboot/corebootnerf --fetch
... lots and lots of output!
</code></pre>
<p>This produces a coreboot image in coreboot-4.9/build/coreboot.rom
You can now run this ROM image:</p>
<pre><code>qemu-system-x86_64 -serial stdio -bios coreboot-4.9/build/coreboot.rom
</code></pre>
<p>And see how it looks when you put this in a coreboot ROM image.</p>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<p>The final image is built on top of multiple open-source components:</p>
<ul>
<li><a href="https://coreboot.org">coreboot</a>, used for the platform initialization.
Silicon and DRAM initialization are done here.</li>
<li><a href="https://kernel.org">Linux</a>, used to initialize peripherals and various
device drivers like file systems, storage and network devices; network stack;
a multiuser and multitasking environment.</li>
<li><a href="https://github.com/u-root/u-root">u-root</a>, an user-space environment that
provides basic libraries and utilities to work in a Linux environment.</li>
<li><del><a href="https://systemboot.org">systemboot</a>, an additional set of libraries and
tools on top of u-root, that provide a bootloader behaviour for various
booting scenarios.</del> systemboot was merged into u-root.</li>
</ul>
<p>These components are built in reverse order. <code>u-root</code> and <code>systemboot</code> are
built together in a single step.</p>
<h2 id="building-u-root"><a class="header" href="#building-u-root">Building u-root</a></h2>
<p>The first step is building the initramfs. This is done using the <code>u-root</code> ramfs
builder, with additional tools and libraries from <code>systemboot</code>.</p>
<p>u-root is written in Go. We recommend using a relatively recent version of the
Go toolchain. At the time of writing the latest is 1.11, and we recommend using
at least version 1.10. Previous versions may not be fully supported.</p>
<p>Adjust your <code>PATH</code> to include <code>${GOPATH}/bin</code>, in order to find the <code>u-root</code>
command that we will use in the next steps.</p>
<p>Then, fetch <code>u-root</code> and its dependencies:</p>
<pre><code>go get -u github.com/u-root/u-root
</code></pre>
<p>Then build the ramfs in busybox mode, and add fbnetboot, localboot, and a custom
uinit to wrap everything together:</p>
<pre><code>u-root -build=bb core github.com/u-root/u-root/cmds/boot/{uinit,localboot,fbnetboot}
</code></pre>
<p>This command will generate a ramfs named <code>/tmp/initramfs_${os}_${arch}.cpio</code>,
e.g. <code>/tmp/initramfs.linux_amd64.cpio</code>. You can specify an alternative output
path with <code>-o</code>. Run <code>u-root -h</code> for additional command line parameters.</p>
<p>Note: the above command will include only pure-Go commands from <code>u-root</code>. If
you need to include other files or non-Go binaries, use the <code>-file</code> option in
<code>u-root</code>.  For example, you may want to include static builds of <code>kexec</code> or
<code>flashrom</code>, that we build on https://github.com/systemboot/binaries .</p>
<p>Then, the initramfs has to be compressed. This step is necessary to embed the
initramfs in the kernel as explained below, in order to maintain the image size
smaller. Linux has a limited XZ compressor, so the compression requires specific
options:</p>
<pre><code>xz --check=crc32 --lzma2=dict=512KiB /tmp/initramfs.linux_amd64.cpio
</code></pre>
<p>which will produce the file <code>/tmp/initramfs.linux_amd64.cpio.xz</code>.</p>
<p>The kernel compression requirements are documented under
<a href="https://www.kernel.org/doc/Documentation/xz.txt">Documentation/xz.txt</a> (last
checked 2018-12-03) in the kernel docs.</p>
<h2 id="building-a-suitable-linux-kernel"><a class="header" href="#building-a-suitable-linux-kernel">Building a suitable Linux kernel</a></h2>
<p>A sample config to use with QEMU can be downloaded here:
<a href="linux-4.19.6-linuxboot.config">linux-4.19.6-linuxboot.config</a>.</p>
<p>You need a relatively recent kernel. Ideally a kernel 4.16, to have support for
VPD variables, but a 4.11 can do the job too, if you don't care about boot
entries and want "brute-force" booting only.</p>
<p>We will build a kernel with the following properties:</p>
<ul>
<li>small enough to fit most flash chips, and with some fundamental kernel features</li>
<li>that can run Go programs (mainly futex and epoll support)</li>
<li>with the relevant storage and network stack and drivers</li>
<li>with kexec support, so it can boot a new kernel</li>
<li>with kexec signature verification disabled (optional)</li>
<li>with devtmpfs enabled, since we don't use udev</li>
<li>XZ support to decompress the embedded initramfs</li>
<li>VPD (Vital Product Data) (optional)</li>
<li>TPM support (optional)</li>
<li>embed the u-root initramfs</li>
<li>and last but not least, "linuxboot" as default host name :)</li>
</ul>
<h3 id="download-kernel-sources"><a class="header" href="#download-kernel-sources">Download kernel sources</a></h3>
<p>You can either download a tarball from kernel.org, or get it via git and use a
version tag. We recommend at least a kernel 4.16, in order to have VPD
variables support.</p>
<pre><code># download the kernel tarball. Replace 4.19.6` with whatever kernel version you want
wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.19.6.tar.xz
tar xvJf linux-4.19.6.tar.xz
cd linux-4.19.6
make tinyconfig
</code></pre>
<p>You can also check out the <code>linux-stable</code> branch, that will point to the latest
stable commit. You need to download it via <code>git</code> as follows:</p>
<pre><code>git clone --depth 1 -b linux-stable
git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git
cd linux-stable
make tinyconfig
</code></pre>
<p>Some more information about tiny configs can be found at
https://tiny.wiki.kernel.org (last checked 2018-12-01).</p>
<h3 id="a-few-fundamental-features"><a class="header" href="#a-few-fundamental-features">A few fundamental features</a></h3>
<p>Assuming we are running on <code>x86_64</code>, some basic features to enable are:</p>
<ul>
<li><code>64-bit kernel</code></li>
<li><code>General setup</code> → <code>Configure standard kernel features</code> → <code>Enable support for printk</code></li>
<li><code>General setup</code> → <code>Configure standard kernel features</code> → <code>Multiple users, groups and capabilities support</code> (this is not strictly required on
LinuxBoot)</li>
<li><code>Processor type and features</code> → <code>Built-in kernel command line</code>
(customize your command line here if needed, e.g.
<code>earlyprintk=serial,ttyS0,57600 console=ttyS0,57600</code>)</li>
<li><code>Executable file formats / Emulations</code> → <code>Kernel support for ELF binaries</code> (you may want to enable more formats)</li>
<li><code>Networking support</code> → <code>Networking options</code> → <code>TCP/IP networking</code></li>
<li><code>Networking support</code> → <code>Networking options</code> → <code>The IPv6 protocol</code></li>
<li><code>Device Drivers</code> → <code>Character devices</code> → <code>Enable TTY</code></li>
<li><code>Device Drivers</code> → <code>Character devices</code> → <code>Serial drivers</code> →
<code>8250/16550 and compatible serial support</code></li>
<li><code>Device Drivers</code> → <code>Character devices</code> → <code>Serial drivers</code> →
<code>Console on 8250/16550 and compatible serial port</code></li>
<li><code>File systems</code> → <code>Pseudo filesystems</code> → <code>/proc file system support</code></li>
<li><code>File systems</code> → <code>Pseudo filesystems</code> → <code>sysfs file system support</code></li>
</ul>
<h3 id="requirements-for-go-111"><a class="header" href="#requirements-for-go-111">Requirements for Go 1.11</a></h3>
<p><code>Go</code> requires a few kernel features to work properly. At the time of writing,
you need to enable <code>CONFIG_FUTEX</code> in your kernel config. Older versions of Go
may require <code>CONFIG_EPOLL</code>.</p>
<p>In menuconfig:</p>
<ul>
<li><code>General setup</code> → <code>Configure standard kernel features (expert users)</code>
→ <code>Enable futex support</code></li>
<li><code>General setup</code> → <code>Configure standard kernel features (expert users)</code>
→ <code>Enable eventpoll support</code></li>
</ul>
<p>Additional information about Go's minimum requirements can be found at
https://github.com/golang/go/wiki/MinimumRequirements (last checked
2018-12-01).</p>
<h3 id="enable-devtmpfs"><a class="header" href="#enable-devtmpfs">Enable devtmpfs</a></h3>
<p>Our system firmware uses u-root, which does not have (intentionally) an <code>udev</code>
equivalent. Therefore, to have <code>/dev/</code> automatically populated at boot time you
should enable devtmps.</p>
<p>Simply enable <code>CONFIG_DEVTMPFS</code> and <code>CONFIG_DEVTMPFS_MOUNT</code> in your kernel
config.</p>
<p>In menuconfig:</p>
<ul>
<li><code>Device drivers</code> → <code>Generic Driver Options</code> → <code>Maintain a devtmpfs filesystem to mount at /dev</code></li>
<li><code>Device drivers</code> → <code>Generic Driver Options</code> → <code>Automount devtmpfs at /dev, after the kernel mounted the rootfs</code></li>
</ul>
<h3 id="additional-drivers"><a class="header" href="#additional-drivers">Additional drivers</a></h3>
<p>This really depends on your hardware. You may want to add all the relevant
drivers for the platforms you plan to run LinuxBoot on. For example you may
need to include NIC drivers, file system drivers, and any other device that you
need at boot time.</p>
<p>For example, enable SCSI disk, SATA drivers, EXT4, and e1000 NIC driver. In
menuconfig:</p>
<ul>
<li><code>Bus options</code> → <code>PCI support</code></li>
<li><code>Enable the block layer</code></li>
<li><code>Device drivers</code> → <code>Block devices</code> (required for SCSI and SATA)</li>
<li><code>Device drivers</code> → <code>SCSI device support</code> → <code>SCSI disk support</code></li>
<li><code>Device drivers</code> → <code>Serial ATA and Parallel ATA drivers</code></li>
<li><code>File systems</code> → <code>The Extended 4 (ext4) filesystem</code></li>
<li><code>Networking support</code> (required for e1000)</li>
<li><code>Device drivers</code> → <code>Network device support</code> → <code>Ethernet driver support</code> → <code>Intel(R) PRO/1000 Gigabit Ethernet support</code></li>
</ul>
<h3 id="enable-xz-kernel-and-initramfs-compression-support"><a class="header" href="#enable-xz-kernel-and-initramfs-compression-support">Enable XZ kernel and initramfs compression support</a></h3>
<p>The <code>u-root</code>-based RAMFS will be compressed with XZ and embedded in the kernel.
Hence you need to enable XZ compression support. Make sure to have at least
<code>CONFIG_HAVE_KERNEL_XZ</code>, <code>CONFIG_KERNEL_XZ</code>, <code>CONFIG_DECOMPRESS_XZ</code>.</p>
<p>In menuconfig:</p>
<ul>
<li><code>General setup</code> → <code>Kernel compression mode</code> → <code>XZ</code></li>
<li><code>General setup</code> → <code>Initial RAM filesystem and RAM disk (initramfs/initrd) support</code> → <code>Support initial ramdisk/ramfs compressed using XZ</code></li>
</ul>
<h3 id="enable-vpd"><a class="header" href="#enable-vpd">Enable VPD</a></h3>
<p>VPD stands for <a href="https://chromium.googlesource.com/chromiumos/platform/vpd/+/1c1806d8df4bb5976eed71a2e2bf156c36ccdce2/README.md">Vital Product
Data</a>.
We use VPD to store boot configuration for <code>localboot</code> and <code>fbnetboot</code>,
similarly to UEFI's boot variables. Linux supports VPD out of the box, but you
need at least a kernel 4.16.</p>
<p>Make sure to have <code>CONFIG_GOOGLE_VPD</code> enabled in your kernel config.</p>
<p>In menuconfig:</p>
<ul>
<li><code>Firmware drivers</code> → <code>Google Firmware Drivers</code> → <code>Coreboot Table Access - ACPI</code> → <code>Vital Product Data</code></li>
</ul>
<h3 id="tpm-support"><a class="header" href="#tpm-support">TPM support</a></h3>
<p>This also depends on your needs. If you plan to use TPM, and this is supported
by your platform, make sure to enable <code>CONFIG_TCG_TPM</code>.</p>
<p>In menuconfig:</p>
<ul>
<li><code>Device drivers</code> → <code>Character devices</code> → <code>TPM Hardware Support</code>
→ (enable the relevant drivers)</li>
</ul>
<h3 id="include-the-initramfs"><a class="header" href="#include-the-initramfs">Include the initramfs</a></h3>
<p>As mentioned above, the kernel will embed the compressed initramfs image. Your
kernel configuration should point to the appropriate file using the
<code>CONFIG_INITRAMFS_SOURCE</code> directive. E.g.</p>
<pre><code>CONFIG_INITRAMFS_SOURCE="/path/to/initramfs_linux.x86_64.cpio.xz"
</code></pre>
<p>In menuconfig:</p>
<ul>
<li><code>General setup</code> → <code>Initial RAM filesystem and RAM disk (initramfs/initrd) support</code> → <code>Initramfs source file(s)</code></li>
</ul>
<h3 id="default-hostname"><a class="header" href="#default-hostname">Default hostname</a></h3>
<p>We use "linuxboot" as the default hostname. You may want to adjust it to a
different value. You need to set <code>CONFIG_DEFAULT_HOSTNAME</code> for the purpose. For
example:</p>
<pre><code>CONFIG_DEFAULT_HOSTNAME="linuxboot"
</code></pre>
<p>In menuconfig:</p>
<ul>
<li><code>General setup</code> → <code>Default hostname</code></li>
</ul>
<h3 id="build-the-kernel"><a class="header" href="#build-the-kernel">Build the kernel</a></h3>
<p>Once your configuration is ready, build the kernel as usual:</p>
<pre><code>make -j$(nproc --ignore=1)
</code></pre>
<p>The image will be located under <code>arch/${ARCH}/boot/bzImage</code> if your
architecture supports bzImage (e.g. x86).</p>
<p>For more details on how to build a kernel, see
https://kernelnewbies.org/KernelBuild (last checked 2018-12-01).</p>
<h2 id="building-coreboot"><a class="header" href="#building-coreboot">Building coreboot</a></h2>
<p>In this step we will build <code>coreboot</code> using the Linux kernel image that we
built at the previous step as payload. This build is for a Qemu x86 target, the
process may be somehow different for other platforms.</p>
<p>Steps overview:</p>
<ul>
<li>download coreboot from the git repo</li>
<li>build the compiler toolchain</li>
<li>configure coreboot for Qemu, and to use our <code>bzImage</code> as payload</li>
<li>build <code>coreboot.rom</code></li>
</ul>
<h3 id="download-coreboot"><a class="header" href="#download-coreboot">Download coreboot</a></h3>
<p>Our preferred method is to download coreboot from the git repository:</p>
<pre><code>git clone https://review.coreboot.org/coreboot.git
cd coreboot
</code></pre>
<h3 id="build-the-compiler-toolchain"><a class="header" href="#build-the-compiler-toolchain">Build the compiler toolchain</a></h3>
<p>This step is required to have, among other things, reproducible builds, and a
compiler toolchain that is known to work with coreboot.</p>
<pre><code>make crossgcc-i386 CPUS=$(nproc) BUILD_LANGUAGES=c
</code></pre>
<p>The step above may ask you to install a few additional libraries or headers, do
so as requested, with the exception of gcc-gnat, that we won't need.</p>
<h3 id="configure-coreboot-for-qemu-and-our-payload"><a class="header" href="#configure-coreboot-for-qemu-and-our-payload">Configure coreboot for Qemu and our payload</a></h3>
<p>Run <code>make menuconfig</code> to enter the coreboot configuration menus. Then:</p>
<p>Specify the platform we will run on:</p>
<ul>
<li><code>Mainboard</code> → <code>Mainboard vendor</code> → <code>Emulation</code></li>
<li><code>Mainboard</code> → <code>Mainboard Model</code> → <code>QEMU x86 q35/ich9 (aka qemu -M q35, since v1.4)</code></li>
</ul>
<p>Specify a large enough flash chip and CBFS size:</p>
<ul>
<li><code>Mainboard</code> → <code>ROM chip size</code> → <code>16 MB</code></li>
<li><code>Mainboard</code> → <code>Size of CBFS filesystem in ROM</code> → <code>0x1000000</code></li>
</ul>
<p>Specify our payload:</p>
<ul>
<li><code>Payload</code> → <code>Add a payload</code> → <code>A Linux payload</code></li>
<li><code>Payload</code> → <code>Linux path and filename</code> → path to your bzImage</li>
</ul>
<p>Then save your configuration and exit menuconfig.</p>
<h3 id="build-coreboot"><a class="header" href="#build-coreboot">Build coreboot</a></h3>
<p>This is done with a simple</p>
<pre><code>make -j$(nproc)
</code></pre>
<p>The coreboot build system will clone the relevant submodules, if it was not done
already, and will build a coreboot ROM file that will contain the initialization
code, and our bzImage payload. The output file is at <code>build/coreboot.rom</code>.</p>
<p>If everything works correctly you will get an output similar to the following:</p>
<pre><code>This image contains the following sections that can be manipulated with this tool:

'COREBOOT' (CBFS, size 16776704, offset 512)

It is possible to perform either the write action or the CBFS add/remove actions on every section listed above.
To see the image's read-only sections as well, rerun with the -w option.
    CBFSPRINT  coreboot.rom

FMAP REGION: COREBOOT
Name                           Offset     Type           Size   Comp
cbfs master header             0x0        cbfs header        32 none
fallback/romstage              0x80       stage           15300 none
fallback/ramstage              0x3cc0     stage           51805 none
config                         0x10780    raw               155 none
revision                       0x10880    raw               576 none
cmos_layout.bin                0x10b00    cmos_layout       548 none
fallback/dsdt.aml              0x10d80    raw              6952 none
fallback/payload               0x12900    simple elf    5883908 none
(empty)                        0x5af140   null         10800216 none
bootblock                      0xffbdc0   bootblock       16384 none

Built emulation/qemu-q35 (QEMU x86 q35/ich9)
</code></pre>
<h2 id="putting-everything-together"><a class="header" href="#putting-everything-together">Putting everything together</a></h2>
<p>TODO</p>
<h2 id="defining-boot-entries"><a class="header" href="#defining-boot-entries">Defining boot entries</a></h2>
<p>TODO</p>
<h2 id="running-on-a-virtual-machine"><a class="header" href="#running-on-a-virtual-machine">Running on a virtual machine</a></h2>
<p>The image built with the above steps can run on a QEMU virtual machine, using
the machine type <code>q35</code>, as specified in the coreboot mainboard section.
Assuming that your coreboot image is located at <code>build/coreboot.rom</code>, you can
run the following command:</p>
<pre><code>sudo qemu-system-x86_64\        # sudo is required to enable KVM below
    -M q35 \                    # the machine type specified in the coreboot mainboard configuration
    -enable-kvm \               # use KVM to avail of hardware virtualization extensions
    -bios build/coreboot.rom \  # the coreboot ROM to run as system firmware
    -m 1024 \                   # the amount of RAM in MB
    -object rng-random,filename=/dev/urandom,id=rng0 \
                                # RNG to avoid DHCP lockups when waiting for entropy
    -nographic                  # redirect all the output to the console
</code></pre>
<p>If everything has been done correctly you should see, in order, the output from
<code>coreboot</code>, <code>linux</code>, <code>u-root</code>, and <code>systemboot</code>. You can press <code>ctrl-c</code> when
Systemboot instructs you to do so, to enter the <code>u-root</code> shell.</p>
<h2 id="running-on-real-ocp-hardware"><a class="header" href="#running-on-real-ocp-hardware">Running on real OCP hardware</a></h2>
<p>TODO</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../implementation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../glossary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../implementation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../glossary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>
        <script src="../theme/js/language-picker.js"></script>


    </div>
    </body>
</html>
